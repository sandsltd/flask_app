{% extends "partials/base.html" %}

{% block content %}
<div class="purchase-container">
    <!-- Event Header Section with Image and Organizer Logo -->
    <div class="event-header">
        {% if event.image_url %}
            <img src="{{ event.image_url }}" alt="Event Image" class="event-image">
        {% else %}
            <img src="{{ url_for('static', filename='images/event-placeholder.png') }}" alt="Event Image" class="event-image">
        {% endif %}
        <div class="event-info">
            {% if organizer.logo_url %}
                <img src="{{ organizer.logo_url }}" alt="Organizer Logo" class="organizer-logo">
            {% else %}
                <img src="{{ url_for('static', filename='images/logo-placeholder.png') }}" alt="Organizer Logo" class="organizer-logo">
            {% endif %}
            <h1>{{ event.name }}</h1>
            <p>{{ event.description }}</p>
            <div class="event-details">
                <p><strong>Date:</strong> {{ event.date | datetimeformat }}</p>
                <p><strong>Time:</strong> {{ event.start_time }} - {{ event.end_time }}</p>
                <p><strong>Location:</strong> {{ event.location }}</p>
            </div>
            <!-- Organizer Contact Links -->
            <div class="organizer-contact">
                <p><strong>Contact Email:</strong> <a href="mailto:{{ organizer.email }}">{{ organizer.email }}</a></p>
                {% if organizer.website_url %}
                    <p><strong>Website:</strong> <a href="{{ organizer.website_url }}" target="_blank">{{ organizer.website_url }}</a></p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Purchase Form -->
    <div class="purchase-form">
        {% if enforce_individual_ticket_limits %}
            <p>Please select the number of tickets for each ticket type (limited availability):</p>
        {% else %}
            <p>Total Tickets Available: {{ tickets_available }}</p>
            <p>Please select the number of tickets for each ticket type:</p>
        {% endif %}

        <form method="POST" action="{{ url_for('purchase', event_id=event.id) }}" enctype="multipart/form-data">
            <!-- Buyer Information -->
            <h2>Your Information</h2>

            <div class="form-group">
                <label for="full_name">Full Name:</label>
                <input type="text" id="full_name" name="full_name" required>
            </div>

            <div class="form-group">
                <label for="email">Email Address:</label>
                <input type="email" id="email" name="email" required>
            </div>

            <div class="form-group">
                <label for="phone_number">Telephone Number:</label>
                <input type="tel" id="phone_number" name="phone_number" required>
            </div>

            <!-- Ticket Selection -->
            <h2>Select Tickets</h2>
            <div id="ticket_selection">
                {% for ticket_type in ticket_types %}
                    <div class="ticket-type">
                        <label>{{ ticket_type.name }} (£{{ "{:.2f}".format(ticket_type.price) }})</label>
                        {% if enforce_individual_ticket_limits %}
                            {% set tickets_sold_type = ticket_type.attendees | selectattr('payment_status', 'equalto', 'succeeded') | list | length %}
                            {% set tickets_remaining = ticket_type.quantity - tickets_sold_type %}
                            <p>Tickets Available: {{ tickets_remaining }}</p>
                            <input
                                type="number"
                                name="quantity_{{ ticket_type.id }}"
                                min="0"
                                max="{{ tickets_remaining }}"
                                value="0"
                                data-ticket-type-id="{{ ticket_type.id }}"
                                data-ticket-price="{{ "{:.2f}".format(ticket_type.price) }}"
                                class="ticket-input"
                            >
                        {% else %}
                            <input
                                type="number"
                                name="quantity_{{ ticket_type.id }}"
                                min="0"
                                value="0"
                                data-ticket-type-id="{{ ticket_type.id }}"
                                data-ticket-price="{{ "{:.2f}".format(ticket_type.price) }}"
                                class="ticket-input"
                            >
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <!-- Total Price -->
            <div class="form-group">
                <label>Total Price:</label>
                <p id="total_price">£0.00</p>
            </div>

            <!-- Attendee Information -->
            <h2>Attendee Information</h2>
            <div id="question_forms">
                <!-- Question forms will be dynamically added here -->
            </div>

            <!-- Terms and Conditions Checkboxes -->
            <h2>Terms and Conditions</h2>
            {% if organizer_terms_link %}
            <div class="form-group checkbox-group">
                <input type="checkbox" id="accept_organizer_terms" name="accept_organizer_terms" required>
                <label for="accept_organizer_terms">
                    I accept the <a href="{{ organizer_terms_link }}" target="_blank">event organiser's Terms and Conditions</a>.
                </label>
            </div>
            {% endif %}
            <div class="form-group checkbox-group">
                <input type="checkbox" id="accept_platform_terms" name="accept_platform_terms" required>
                <label for="accept_platform_terms">
                    I accept the <a href="{{ platform_terms_link }}" target="_blank">platform's Terms and Conditions</a>.
                </label>
            </div>

            <input type="submit" value="Proceed to Payment" class="submit-btn">
        </form>

        {% if error %}
            <p class="error-msg">{{ error }}</p>
        {% endif %}
    </div>
</div>

<!-- Include your JavaScript code after the form -->
<script type="application/json" id="questions-data">
    {{ questions | tojson }}
</script>

<script>
    // Parse the questions data from the script tag
    var questionsDataElement = document.getElementById('questions-data');
    var questions = JSON.parse(questionsDataElement.textContent);

    function updateQuestionForms() {
        var ticketInputs = document.querySelectorAll('.ticket-input');
        var formsContainer = document.getElementById('question_forms');
        formsContainer.innerHTML = '';

        var totalPrice = 0;

        ticketInputs.forEach(function(input) {
            var quantity = parseInt(input.value) || 0;
            var ticketTypeId = input.getAttribute('data-ticket-type-id');
            var ticketTypePrice = parseFloat(input.getAttribute('data-ticket-price'));

            totalPrice += quantity * ticketTypePrice;

            for (var i = 0; i < quantity; i++) {
                var ticketDiv = document.createElement('div');
                ticketDiv.classList.add('attendee-group');

                var attendeeHeader = document.createElement('h3');
                attendeeHeader.textContent = 'Ticket Type: ' + input.previousElementSibling.textContent + ' - Ticket ' + (i + 1);
                ticketDiv.appendChild(attendeeHeader);

                for (var j = 0; j < questions.length; j++) {
                    var formGroup = document.createElement('div');
                    formGroup.classList.add('form-group');

                    var label = document.createElement('label');
                    label.setAttribute('for', 'ticket_' + ticketTypeId + '_' + i + '_question_' + j);
                    label.textContent = questions[j];

                    var inputField = document.createElement('input');
                    inputField.type = 'text';
                    inputField.name = 'ticket_' + ticketTypeId + '_' + i + '_question_' + j;
                    inputField.required = true;

                    formGroup.appendChild(label);
                    formGroup.appendChild(inputField);
                    ticketDiv.appendChild(formGroup);
                }

                formsContainer.appendChild(ticketDiv);
            }
        });

        // Update total price
        var totalPriceElement = document.getElementById('total_price');
        totalPriceElement.textContent = '£' + totalPrice.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateQuestionForms();

        var ticketInputs = document.querySelectorAll('.ticket-input');
        ticketInputs.forEach(function(input) {
            input.addEventListener('change', updateQuestionForms);
            input.addEventListener('input', updateQuestionForms);
        });
    });
</script>

<style>
    /* Scoped styles for the purchase page */

    .purchase-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 50px auto;
        max-width: 1200px;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .event-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        margin-bottom: 30px;
    }

    .event-image {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        border-radius: 10px;
    }

    .event-info {
        width: 100%;
        padding: 20px;
        text-align: center;
    }

    .organizer-logo {
        width: 100px;
        height: 100px;
        object-fit: contain;
        border-radius: 50%;
        margin-bottom: 15px;
    }

    .event-details, .organizer-contact {
        margin-top: 10px;
    }

    .organizer-contact a {
        color: #ff0000;
        text-decoration: none;
    }

    .organizer-contact a:hover {
        text-decoration: underline;
    }

    .purchase-form {
        width: 100%;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
    }

    .purchase-form h1 {
        color: #ff0000;
        text-align: center;
        margin-bottom: 20px;
    }

    .purchase-form h2 {
        color: #ff0000;
        margin-top: 30px;
        margin-bottom: 15px;
    }

    .purchase-form p {
        margin-bottom: 15px;
        color: #333;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="tel"],
    .form-group input[type="number"],
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        box-sizing: border-box;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .checkbox-group input[type="checkbox"] {
        margin-right: 10px;
    }

    .submit-btn {
        width: 100%;
        padding: 15px;
        background-color: #ff0000;
        color: white;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
        transition: background-color 0.3s ease;
    }

    .submit-btn:hover {
        background-color: #cc0000;
    }

    .error-msg {
        color: red;
        margin-top: 15px;
    }

    .attendee-group {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        background-color: #fff;
    }

    .attendee-group h3 {
        color: #ff0000;
        margin-bottom: 10px;
    }

    .ticket-type {
        margin-bottom: 15px;
    }

    .ticket-type label {
        display: block;
        margin-bottom: 5px;
    }

    .ticket-type input[type="number"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    /* Additional styles for the total price */
    #total_price {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
    }

    /* Responsive Design */
    @media (min-width: 768px) {
        .event-header {
            flex-direction: row;
            align-items: flex-start;
        }

        .event-image {
            width: 60%;
            max-height: 400px;
        }

        .event-info {
            width: 40%;
            padding: 20px;
            text-align: left;
        }
    }
</style>

{% endblock %}