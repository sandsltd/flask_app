{% extends "partials/base.html" %}


{% block content %}
<div class="purchase-container">
    <!-- Event Header Section with Image and Organizer Logo -->
    <div class="event-header">
        {% if event.image_url %}
            <img src="{{ event.image_url }}" alt="Event Image" class="event-image">
        {% else %}
            <img src="{{ url_for('static', filename='images/event-placeholder.png') }}" alt="Event Image" class="event-image">
        {% endif %}
        <div class="event-info">
            {% if organizer.business_logo_url %}
                <img src="{{ organizer.business_logo_url }}" alt="Organizer Logo" class="organizer-logo">
            {% else %}
                <img src="{{ url_for('static', filename='images/logo-placeholder.png') }}" alt="Organizer Logo" class="organizer-logo">
            {% endif %}
            <h1>{{ event.name }}</h1>
            <p>{{ event.description }}</p>
            <div class="event-details">
                <p><strong>Date:</strong> {{ event.date | datetimeformat }}</p>
                <p><strong>Time:</strong> {{ event.start_time }} - {{ event.end_time }}</p>
                <p><strong>Location:</strong> {{ event.location }}</p>
            </div>
            <!-- Organizer Contact Links -->
            <div class="organizer-contact">
                <p><strong>Contact Email:</strong> <a href="mailto:{{ organizer.email }}">{{ organizer.email }}</a></p>
                {% if organizer.website_url %}
                    <p><strong>Website:</strong> <a href="{{ organizer.website_url }}" target="_blank">{{ organizer.website_url }}</a></p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Update the discount banner HTML -->
<div id="discount-banner" class="discount-banner" style="display: none;">
    <div class="discount-content">
        <div class="offer-badge-container">
            <span class="offer-badge">Special Offer</span>
        </div>
        <div class="discount-message-container">
            <p id="discount-message"></p>
            <p class="discount-subtitle">Add tickets to your cart to apply the discount!</p>
        </div>
        <button type="button" class="close-banner">×</button>
    </div>
</div>

<!-- Purchase Form -->
<div class="purchase-form">
    {% if enforce_individual_ticket_limits %}
        <p>Please select the number of tickets for each ticket type (limited availability):</p>
    {% else %}
        <p>Total Tickets Available: {{ tickets_available }}</p>
        <p>Please select the number of tickets for each ticket type:</p>
    {% endif %}

    <form method="POST" action="{{ url_for('purchase', event_id=event.id) }}" enctype="multipart/form-data">
        <!-- Buyer Information -->
        <h2>Your Information</h2>

        <div class="form-group">
            <label for="full_name">Full Name:</label>
            <input type="text" id="full_name" name="full_name" required>
        </div>

        <div class="form-group">
            <label for="email">Email Address:</label>
            <input type="email" id="email" name="email" required>
        </div>

        <div class="form-group">
            <label for="phone_number">Telephone Number:</label>
            <input type="tel" id="phone_number" name="phone_number" required>
        </div>

        <!-- Ticket Selection -->
        <h2>Select Tickets</h2>
        <div id="ticket_selection">
            {% for ticket_type in ticket_types %}
                <div class="ticket-type">
                    <div class="ticket-header">
                        <label>{{ ticket_type.name }}</label>
                        <div class="ticket-price-display" id="price-display-{{ ticket_type.id }}">
                            <span class="original-price">£{{ "{:.2f}".format(ticket_type.price) }}</span>
                            <span class="discounted-price" style="display: none;"></span>
                        </div>
                    </div>
                    {% if enforce_individual_ticket_limits %}
                        {% set tickets_sold_type = ticket_type.attendees | selectattr('payment_status', 'equalto', 'succeeded') | list | length %}
                        {% set tickets_remaining = ticket_type.quantity - tickets_sold_type %}
                        <p class="tickets-remaining">Tickets Available: {{ tickets_remaining }}</p>
                        <input
                            type="number"
                            name="quantity_{{ ticket_type.id }}"
                            min="0"
                            max="{{ tickets_remaining }}"
                            value="0"
                            data-ticket-type-id="{{ ticket_type.id }}"
                            data-ticket-price="{{ "{:.2f}".format(ticket_type.price) }}"
                            class="ticket-input"
                        >
                    {% else %}
                        <input
                            type="number"
                            name="quantity_{{ ticket_type.id }}"
                            min="0"
                            value="0"
                            data-ticket-type-id="{{ ticket_type.id }}"
                            data-ticket-price="{{ "{:.2f}".format(ticket_type.price) }}"
                            class="ticket-input"
                        >
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <!-- Total Price -->
        <div class="form-group">
            <label>Total Price:</label>
            <p id="total_price">£0.00</p>
        </div>

        <!-- Add this after the total price div -->
        <div id="question_forms">
            <!-- Question forms will be dynamically added here -->
        </div>

        <!-- Terms and Conditions Checkboxes -->
        <h2>Terms and Conditions</h2>
        {% if organizer_terms_link %}
        <div class="form-group checkbox-group">
            <input type="checkbox" id="accept_organizer_terms" name="accept_organizer_terms" required>
            <label for="accept_organizer_terms">
                I accept the <a href="{{ organizer_terms_link }}" target="_blank">event organiser's Terms and Conditions</a>.
            </label>
        </div>
        {% endif %}
        <div class="form-group checkbox-group">
            <input type="checkbox" id="accept_platform_terms" name="accept_platform_terms" required>
            <label for="accept_platform_terms">
                I accept the <a href="{{ platform_terms_link }}" target="_blank">platform's Terms and Conditions</a>.
            </label>
        </div>

        <!-- Add this in your form -->
        <div class="promo-code-section">
            <label for="promo_code">Promo Code (if applicable):</label>
            <input type="text" id="promo_code" name="promo_code">
        </div>

        <input type="submit" value="Proceed to Payment" class="submit-btn">
    </form>

    {% if error %}
        <p class="error-msg">{{ error }}</p>
    {% endif %}
</div>

<!-- Add this before your main script -->
<script type="application/json" id="questions-data">
    {{ questions | tojson | safe }}
</script>

<script type="application/json" id="discount-config">
    {{ discount_config | tojson | safe }}
</script>

<script>
    var discountConfig = JSON.parse(document.getElementById('discount-config').textContent);
    var questions = JSON.parse(document.getElementById('questions-data').textContent);

    // Show discount banner if bulk discount is available
    function initializeDiscountBanner() {
        if (discountConfig.apply_to === 'bulk') {
            const banner = document.getElementById('discount-banner');
            const message = document.getElementById('discount-message');
            const subtitle = document.querySelector('.discount-subtitle');
            
            // Create specific message based on discount type
            let mainMessage = '';
            let subtitleMessage = '';
            
            if (discountConfig.apply_to === 'all') {
                mainMessage = `Buy ${discountConfig.minTickets} or more tickets and save ${discountConfig.percentage}% on ALL tickets!`;
                subtitleMessage = `Purchase ${discountConfig.minTickets} tickets to unlock a ${discountConfig.percentage}% discount on your entire order!`;
            } else {
                mainMessage = `Buy ${discountConfig.minTickets} or more tickets and save ${discountConfig.percentage}% on additional tickets!`;
                subtitleMessage = `First ticket full price, then get ${discountConfig.percentage}% off all additional tickets when you buy ${discountConfig.minTickets} or more!`;
            }
            
            message.textContent = mainMessage;
            subtitle.textContent = subtitleMessage;
            banner.style.display = 'block';

            // Add click handler for close button
            document.querySelector('.close-banner').addEventListener('click', function(e) {
                e.stopPropagation();
                banner.style.display = 'none';
            });
            
            // Optional: Add click handler for the entire banner to show more details
            banner.addEventListener('click', function() {
                const savingsExample = discountConfig.apply_to === 'all' 
                    ? `Save £${((discountConfig.percentage/100) * parseFloat(document.querySelector('.ticket-input').getAttribute('data-ticket-price'))).toFixed(2)} per ticket!`
                    : `Save £${((discountConfig.percentage/100) * parseFloat(document.querySelector('.ticket-input').getAttribute('data-ticket-price'))).toFixed(2)} on each additional ticket!`;
                
                alert(`Special Offer Details:\n\n${mainMessage}\n${subtitleMessage}\n\n${savingsExample}`);
            });
        }
    }

    function updatePriceDisplays(totalQuantity) {
        var ticketInputs = document.querySelectorAll('.ticket-input');
        var applyDiscount = totalQuantity >= discountConfig.minTickets;

        ticketInputs.forEach(function(input) {
            var ticketTypeId = input.getAttribute('data-ticket-type-id');
            var originalPrice = parseFloat(input.getAttribute('data-ticket-price'));
            var priceDisplay = document.getElementById(`price-display-${ticketTypeId}`);
            var originalPriceSpan = priceDisplay.querySelector('.original-price');
            var discountedPriceSpan = priceDisplay.querySelector('.discounted-price');

            if (applyDiscount && discountConfig.apply_to === 'all') {
                // Show discount for all tickets when "all" type
                var discountedPrice = originalPrice * (1 - discountConfig.percentage/100);
                originalPriceSpan.classList.add('strikethrough');
                discountedPriceSpan.textContent = `£${discountedPrice.toFixed(2)}`;
                discountedPriceSpan.style.display = 'inline';
            } else if (applyDiscount && discountConfig.apply_to === 'additional' && totalQuantity > 1) {
                // Show discount only for additional tickets
                originalPriceSpan.classList.remove('strikethrough');
                discountedPriceSpan.textContent = `(Additional tickets: £${(originalPrice * (1 - discountConfig.percentage/100)).toFixed(2)})`;
                discountedPriceSpan.style.display = 'inline';
            } else {
                originalPriceSpan.classList.remove('strikethrough');
                discountedPriceSpan.style.display = 'none';
            }
        });
    }

    // Your existing updateQuestionForms function with added updatePriceDisplays call
    function updateQuestionForms() {
        var ticketInputs = document.querySelectorAll('.ticket-input');
        var formsContainer = document.getElementById('question_forms');
        formsContainer.innerHTML = '';

        var totalQuantity = 0;
        var totalPrice = 0;

        // First pass: calculate total quantity for bulk discount determination
        ticketInputs.forEach(function(input) {
            totalQuantity += parseInt(input.value) || 0;
        });

        // Second pass: calculate prices with discounts
        ticketInputs.forEach(function(input) {
            var quantity = parseInt(input.value) || 0;
            var ticketTypeId = input.getAttribute('data-ticket-type-id');
            var ticketTypePrice = parseFloat(input.getAttribute('data-ticket-price'));

            // Calculate price based on discount configuration
            if (totalQuantity >= discountConfig.minTickets) {
                if (discountConfig.apply_to === 'additional') {
                    // First ticket at full price, rest discounted
                    totalPrice += ticketTypePrice + 
                        (quantity - 1) * (ticketTypePrice * (1 - discountConfig.percentage/100));
                } else if (discountConfig.apply_to === 'all') {
                    // All tickets discounted
                    totalPrice += quantity * (ticketTypePrice * (1 - discountConfig.percentage/100));
                } else {
                    // No discount
                    totalPrice += quantity * ticketTypePrice;
                }
            } else {
                totalPrice += quantity * ticketTypePrice;
            }

            // Create question forms for each ticket
            for (var i = 0; i < quantity; i++) {
                var ticketDiv = document.createElement('div');
                ticketDiv.classList.add('attendee-group');

                var attendeeHeader = document.createElement('h3');
                attendeeHeader.textContent = 'Ticket Type: ' + input.previousElementSibling.textContent + ' - Ticket ' + (i + 1);
                ticketDiv.appendChild(attendeeHeader);

                questions.forEach(function(question, j) {
                    var formGroup = document.createElement('div');
                    formGroup.classList.add('form-group');

                    var label = document.createElement('label');
                    label.setAttribute('for', 'ticket_' + ticketTypeId + '_' + i + '_question_' + j);
                    label.textContent = question;

                    var inputField = document.createElement('input');
                    inputField.type = 'text';
                    inputField.name = 'ticket_' + ticketTypeId + '_' + i + '_question_' + j;
                    inputField.required = true;

                    formGroup.appendChild(label);
                    formGroup.appendChild(inputField);
                    ticketDiv.appendChild(formGroup);
                });

                formsContainer.appendChild(ticketDiv);
            }
        });

        // Update total price display
        var totalPriceElement = document.getElementById('total_price');
        totalPriceElement.textContent = '£' + totalPrice.toFixed(2);

        // Add this line after calculating totalQuantity
        updatePriceDisplays(totalQuantity);
    }

    // Add form submission handler
    document.querySelector('form').addEventListener('submit', function(e) {
        var totalQuantity = Array.from(document.querySelectorAll('.ticket-input'))
            .reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);

        if (discountConfig.apply_to === 'bulk' && 
            totalQuantity > 0 && 
            totalQuantity < discountConfig.minTickets) {
            
            e.preventDefault();
            
            if (confirm(`You're just ${discountConfig.minTickets - totalQuantity} ticket(s) away from saving ${discountConfig.percentage}% on ${discountConfig.apply_to === 'all' ? 'all' : 'additional'} tickets! Would you like to add more tickets?`)) {
                return false;
            }
        }
    });

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeDiscountBanner();
        updateQuestionForms();
        
        var ticketInputs = document.querySelectorAll('.ticket-input');
        ticketInputs.forEach(function(input) {
            input.addEventListener('change', updateQuestionForms);
            input.addEventListener('input', updateQuestionForms);
        });
    });
</script>

<style>
    /* Scoped styles for the purchase page */

    .purchase-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 50px auto;
        max-width: 1200px;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .event-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        margin-bottom: 30px;
    }

    .event-image {
    width: 100%;          /* Full width of container */
    max-height: 400px;    /* Cap height for consistency */
    object-fit: contain;  /* Ensure full image is visible */
    border-radius: 10px;  /* Adds a rounded effect for style */
}

    .event-info {
        width: 100%;
        padding: 20px;
        text-align: center;
    }

    .organizer-logo {
        width: 100px;
        height: 100px;
        object-fit: contain;
        border-radius: 50%;
        margin-bottom: 15px;
    }

    .event-details, .organizer-contact {
        margin-top: 10px;
    }

    .organizer-contact a {
        color: #ff0000;
        text-decoration: none;
    }

    .organizer-contact a:hover {
        text-decoration: underline;
    }

    .purchase-form {
        width: 100%;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
    }

    .purchase-form h1 {
        color: #ff0000;
        text-align: center;
        margin-bottom: 20px;
    }

    .purchase-form h2 {
        color: #ff0000;
        margin-top: 30px;
        margin-bottom: 15px;
    }

    .purchase-form p {
        margin-bottom: 15px;
        color: #333;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="tel"],
    .form-group input[type="number"],
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        box-sizing: border-box;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .checkbox-group input[type="checkbox"] {
        margin-right: 10px;
    }

    .submit-btn {
        width: 100%;
        padding: 15px;
        background-color: #ff0000;
        color: white;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
        transition: background-color 0.3s ease;
    }

    .submit-btn:hover {
        background-color: #cc0000;
    }

    .error-msg {
        color: red;
        margin-top: 15px;
    }

    .attendee-group {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        background-color: #fff;
    }

    .attendee-group h3 {
        color: #ff0000;
        margin-bottom: 10px;
    }

    .ticket-type {
        margin-bottom: 15px;
    }

    .ticket-type label {
        display: block;
        margin-bottom: 5px;
    }

    .ticket-type input[type="number"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    /* Additional styles for the total price */
    #total_price {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
    }

    /* Responsive Design */
    @media (min-width: 768px) {
        .event-header {
            flex-direction: row;
            align-items: flex-start;
        }

        .event-image {
            width: 60%;
            max-height: 400px;
        }

        .event-info {
            width: 40%;
            padding: 20px;
            text-align: left;
        }
    }

    /* Add these new styles before your existing ones */
    .discount-banner {
        background: linear-gradient(45deg, #ffebee 0%, #fff1f2 100%);
        border: 2px solid #ff0000;
        border-radius: 10px;
        padding: 25px;
        margin: 20px auto;
        position: relative;
        cursor: pointer;
        max-width: 1200px;
        box-shadow: 0 4px 8px rgba(255, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .discount-banner:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(255, 0, 0, 0.15);
    }

    .discount-banner:after {
        content: "Click for details";
        position: absolute;
        bottom: 5px;
        right: 10px;
        font-size: 0.8em;
        color: #666;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .discount-banner:hover:after {
        opacity: 1;
    }

    .offer-badge-container {
        flex-shrink: 0;
    }

    .offer-badge {
        background: linear-gradient(45deg, #ff0000 0%, #ff4444 100%);
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
        font-size: 1.1em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(255, 0, 0, 0.2);
    }

    .discount-message-container {
        flex-grow: 1;
    }

    #discount-message {
        font-size: 1.3em;
        font-weight: 600;
        color: #333;
        margin: 0;
        line-height: 1.4;
    }

    .discount-subtitle {
        font-size: 1em;
        color: #666;
        margin: 8px 0 0 0;
        line-height: 1.4;
    }

    .close-banner {
        position: absolute;
        right: 15px;
        top: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 5px;
        line-height: 1;
        transition: color 0.3s ease;
    }

    .close-banner:hover {
        color: #ff0000;
    }

    /* Update ticket price display styles */
    .ticket-price-display {
        margin: 8px 0;
        font-size: 1.1em;
    }

    .original-price {
        color: #333;
        font-weight: 500;
    }

    .original-price.strikethrough {
        text-decoration: line-through;
        color: #666;
    }

    .discounted-price {
        color: #ff0000;
        font-weight: bold;
        margin-left: 10px;
        display: inline-block;
    }
</style>

{% endblock %}